# Pulls signal and noise from light waveforms (for deconvolution filter)

flow:
  source: event_loop
  stages: [pickup_noise_adder, wvfm_filter, wvfm_extract_sig_noise, wvfm_extract_sig_noise_filt]


resources:
  - !include yamls/module0_flow/resources/RunData.yaml
  - !include yamls/module0_flow/resources/LArData.yaml

event_loop:
  classname: H5FlowDatasetLoopGenerator
  path: h5flow.modules
  dset_name: 'light/events'
  params:
    chunk_size: 128

pickup_noise_adder:
  !include yamls/module0_flow/reco/light/PickupNoiseAdder.yaml

wvfm_filter:
  !include yamls/module0_flow/reco/light/WaveformNoiseFilter.yaml

wvfm_extract_sig_noise:
  classname: WaveformDeconvolution
  path: module0_flow.reco.light.wvfm_deconv
  requires:
    - 'light/wvfm'
  params:
    # input
    wvfm_dset_name: 'light/wvfm'

    # outputs
    noise_spectrum_filename: 'wvfm_noise_power-0-256-mixed.npz'
    signal_spectrum_filename: 'wvfm_signal_power-0-256-mixed.npz'
    signal_impulse_filename: 'wvfm_signal_impulse-0-256-mixed.npz'

    # configuration parameters
    #noise_strategy: PPS # or slice
    noise_strategy: slice
    noise_slice: [0, 256] # first 256 samples to avoid trigger mis-aligned events
    noise_amplitude:
        default: [-128, 128]
        #0: {
        #  2: [-500, 500], 3: [-500, 500], 4: [-500, 500], 5: [-500, 500], 6: [-500, 500], 7: [-500, 500],          
        #  18: [-500, 500], 19: [-500, 500], 20: [-500, 500], 21: [-500, 500], 22: [-500, 500], 23: [-500, 500],
        #  34: [-500, 500], 35: [-500, 500], 36: [-500, 500], 37: [-500, 500], 38: [-500, 500], 39: [-500, 500],
        #  50: [-500, 500], 51: [-500, 500], 52: [-500, 500], 53: [-500, 500], 54: [-500, 500], 55: [-500, 500],          
        #  }
        #1: {
        #  2: [-500, 500], 3: [-500, 500], 4: [-500, 500], 5: [-500, 500], 6: [-500, 500], 7: [-500, 500],          
        #  18: [-500, 500], 19: [-500, 500], 20: [-500, 500], 21: [-500, 500], 22: [-500, 500], 23: [-500, 500],
        #  34: [-500, 500], 35: [-500, 500], 36: [-500, 500], 37: [-500, 500], 38: [-500, 500], 39: [-500, 500],
        #  50: [-500, 500], 51: [-500, 500], 52: [-500, 500], 53: [-500, 500], 54: [-500, 500], 55: [-500, 500],          
        #  }
        0: {0: [-115.73955, 115.73955], 1: [-0.0, 0.0], 2: [-317.82208, 317.82208], 3: [-331.1525, 331.1525], 4: [-332.13687, 332.13687], 5: [-339.60083, 339.60083], 6: [-319.03818, 319.03818], 7: [-396.60464, 396.60464], 8: [-454.5478, 454.5478], 9: [-179.74518, 179.74518], 10: [-189.3002, 189.3002], 11: [-190.22272, 190.22272], 12: [-202.4706, 202.4706], 13: [-173.11844, 173.11844], 14: [-184.23747, 184.23747], 15: [-230.0924, 230.0924], 16: [-0.0, 0.0], 17: [-0.0, 0.0], 18: [-317.42557, 317.42557], 19: [-314.13107, 314.13107], 20: [-319.5843, 319.5843], 21: [-333.5687, 333.5687], 22: [-319.61942, 319.61942], 23: [-343.78552, 343.78552], 24: [-1055.4495, 1055.4495], 25: [-206.10072, 206.10072], 26: [-200.41322, 200.41322], 27: [-189.83652, 189.83652], 28: [-180.41618, 180.41618], 29: [-193.74042, 193.74042], 30: [-192.76968, 192.76968], 31: [-370.62155, 370.62155], 32: [-56.35775, 56.35775], 33: [-0.0, 0.0], 34: [-232.1878, 232.1878], 35: [-224.89941, 224.89941], 36: [-178.92186, 178.92186], 37: [-197.41022, 197.41022], 38: [-189.78722, 189.78722], 39: [-176.10597, 176.10597], 40: [-328.59955, 328.59955], 41: [-209.14992, 209.14992], 42: [-214.513, 214.513], 43: [-214.13576, 214.13576], 44: [-190.96854, 190.96854], 45: [-190.67635, 190.67635], 46: [-208.70956, 208.70956], 47: [-377.38693, 377.38693], 48: [-0.0, 0.0], 49: [-0.0, 0.0], 50: [-335.7592, 335.7592], 51: [-330.77393, 330.77393], 52: [-309.0343, 309.0343], 53: [-329.99728, 329.99728], 54: [-322.11267, 322.11267], 55: [-342.63055, 342.63055], 56: [-1260.1464, 1260.1464], 57: [-187.68298, 187.68298], 58: [-201.25166, 201.25166], 59: [-192.01672, 192.01672], 60: [-188.75554, 188.75554], 61: [-189.64394, 189.64394], 62: [-197.17676, 197.17676], 63: [-366.9377, 366.9377]}
        1: {0: [-117.26655, 117.26655], 1: [-0.0, 0.0], 2: [-299.08035, 299.08035], 3: [-306.91068, 306.91068], 4: [-318.87045, 318.87045], 5: [-306.7041, 306.7041], 6: [-320.36014, 320.36014], 7: [-322.89578, 322.89578], 8: [-1137.7451, 1137.7451], 9: [-184.26253, 184.26253], 10: [-184.14499, 184.14499], 11: [-190.43306, 190.43306], 12: [-188.44305, 188.44305], 13: [-187.5702, 187.5702], 14: [-187.24693, 187.24693], 15: [-361.88425, 361.88425], 16: [-0.0, 0.0], 17: [-0.0, 0.0], 18: [-313.88522, 313.88522], 19: [-305.386, 305.386], 20: [-309.28094, 309.28094], 21: [-319.192, 319.192], 22: [-315.93057, 315.93057], 23: [-303.20157, 303.20157], 24: [-1065.9937, 1065.9937], 25: [-182.0629, 182.0629], 26: [-171.91565, 171.91565], 27: [-199.37779, 199.37779], 28: [-190.81038, 190.81038], 29: [-181.42421, 181.42421], 30: [-189.41025, 189.41025], 31: [-364.15158, 364.15158], 32: [-191.69952, 191.69952], 33: [-0.0, 0.0], 34: [-299.78357, 299.78357], 35: [-465.99106, 465.99106], 36: [-433.4436, 433.4436], 37: [-309.03775, 309.03775], 38: [-437.05536, 437.05536], 39: [-461.35114, 461.35114], 40: [-1062.6344, 1062.6344], 41: [-406.7383, 406.7383], 42: [-197.92105, 197.92105], 43: [-575.3014, 575.3014], 44: [-192.57442, 192.57442], 45: [-194.63208, 194.63208], 46: [-198.07117, 198.07117], 47: [-446.51587, 446.51587], 48: [-0.0, 0.0], 49: [-0.0, 0.0], 50: [-301.6436, 301.6436], 51: [-305.9111, 305.9111], 52: [-320.81067, 320.81067], 53: [-457.8309, 457.8309], 54: [-305.64447, 305.64447], 55: [-440.85556, 440.85556], 56: [-997.7101, 997.7101], 57: [-186.0006, 186.0006], 58: [-186.29123, 186.29123], 59: [-187.34105, 187.34105], 60: [-187.99289, 187.99289], 61: [-202.7102, 202.7102], 62: [-549.07916, 549.07916], 63: [-371.51907, 371.51907]}

    # noise_slice: [-256, null] # last 256 samples
    pps_threshold: 5000
    signal_amplitude: [5000,20000]
    gen_noise_spectrum: False
    gen_signal_spectrum: True
    gen_signal_impulse: False
    impulse_alignment_oversampling: 10
    do_filtering: False

wvfm_extract_sig_noise_filt:
  classname: WaveformDeconvolution
  path: module0_flow.reco.light.wvfm_deconv
  requires:
    - 'light/fwvfm'
  params:
    # input
    wvfm_dset_name: 'light/fwvfm'

    # outputs
    noise_spectrum_filename: 'fwvfm_noise_power-0-256-mixed.npz'
    signal_spectrum_filename: 'fwvfm_signal_power-0-256-mixed.npz'
    signal_impulse_filename: 'fwvfm_signal_impulse-0-256-mixed.npz'

    # configuration parameters
    #noise_strategy: PPS # or slice
    noise_strategy: slice
    noise_slice: [0, 256] # first 256 samples to avoid trigger mis-aligned events
    noise_amplitude:
        default: [-128, 128]
        #0: {
        #  2: [-500, 500], 3: [-500, 500], 4: [-500, 500], 5: [-500, 500], 6: [-500, 500], 7: [-500, 500],          
        #  18: [-500, 500], 19: [-500, 500], 20: [-500, 500], 21: [-500, 500], 22: [-500, 500], 23: [-500, 500],
        #  34: [-500, 500], 35: [-500, 500], 36: [-500, 500], 37: [-500, 500], 38: [-500, 500], 39: [-500, 500],
        #  50: [-500, 500], 51: [-500, 500], 52: [-500, 500], 53: [-500, 500], 54: [-500, 500], 55: [-500, 500],          
        #  }
        #1: {
        #  2: [-500, 500], 3: [-500, 500], 4: [-500, 500], 5: [-500, 500], 6: [-500, 500], 7: [-500, 500],          
        #  18: [-500, 500], 19: [-500, 500], 20: [-500, 500], 21: [-500, 500], 22: [-500, 500], 23: [-500, 500],
        #  34: [-500, 500], 35: [-500, 500], 36: [-500, 500], 37: [-500, 500], 38: [-500, 500], 39: [-500, 500],
        #  50: [-500, 500], 51: [-500, 500], 52: [-500, 500], 53: [-500, 500], 54: [-500, 500], 55: [-500, 500],          
        #  }
        0: {0: [-115.73955, 115.73955], 1: [-0.0, 0.0], 2: [-317.82208, 317.82208], 3: [-331.1525, 331.1525], 4: [-332.13687, 332.13687], 5: [-339.60083, 339.60083], 6: [-319.03818, 319.03818], 7: [-396.60464, 396.60464], 8: [-454.5478, 454.5478], 9: [-179.74518, 179.74518], 10: [-189.3002, 189.3002], 11: [-190.22272, 190.22272], 12: [-202.4706, 202.4706], 13: [-173.11844, 173.11844], 14: [-184.23747, 184.23747], 15: [-230.0924, 230.0924], 16: [-0.0, 0.0], 17: [-0.0, 0.0], 18: [-317.42557, 317.42557], 19: [-314.13107, 314.13107], 20: [-319.5843, 319.5843], 21: [-333.5687, 333.5687], 22: [-319.61942, 319.61942], 23: [-343.78552, 343.78552], 24: [-1055.4495, 1055.4495], 25: [-206.10072, 206.10072], 26: [-200.41322, 200.41322], 27: [-189.83652, 189.83652], 28: [-180.41618, 180.41618], 29: [-193.74042, 193.74042], 30: [-192.76968, 192.76968], 31: [-370.62155, 370.62155], 32: [-56.35775, 56.35775], 33: [-0.0, 0.0], 34: [-232.1878, 232.1878], 35: [-224.89941, 224.89941], 36: [-178.92186, 178.92186], 37: [-197.41022, 197.41022], 38: [-189.78722, 189.78722], 39: [-176.10597, 176.10597], 40: [-328.59955, 328.59955], 41: [-209.14992, 209.14992], 42: [-214.513, 214.513], 43: [-214.13576, 214.13576], 44: [-190.96854, 190.96854], 45: [-190.67635, 190.67635], 46: [-208.70956, 208.70956], 47: [-377.38693, 377.38693], 48: [-0.0, 0.0], 49: [-0.0, 0.0], 50: [-335.7592, 335.7592], 51: [-330.77393, 330.77393], 52: [-309.0343, 309.0343], 53: [-329.99728, 329.99728], 54: [-322.11267, 322.11267], 55: [-342.63055, 342.63055], 56: [-1260.1464, 1260.1464], 57: [-187.68298, 187.68298], 58: [-201.25166, 201.25166], 59: [-192.01672, 192.01672], 60: [-188.75554, 188.75554], 61: [-189.64394, 189.64394], 62: [-197.17676, 197.17676], 63: [-366.9377, 366.9377]}
        1: {0: [-117.26655, 117.26655], 1: [-0.0, 0.0], 2: [-299.08035, 299.08035], 3: [-306.91068, 306.91068], 4: [-318.87045, 318.87045], 5: [-306.7041, 306.7041], 6: [-320.36014, 320.36014], 7: [-322.89578, 322.89578], 8: [-1137.7451, 1137.7451], 9: [-184.26253, 184.26253], 10: [-184.14499, 184.14499], 11: [-190.43306, 190.43306], 12: [-188.44305, 188.44305], 13: [-187.5702, 187.5702], 14: [-187.24693, 187.24693], 15: [-361.88425, 361.88425], 16: [-0.0, 0.0], 17: [-0.0, 0.0], 18: [-313.88522, 313.88522], 19: [-305.386, 305.386], 20: [-309.28094, 309.28094], 21: [-319.192, 319.192], 22: [-315.93057, 315.93057], 23: [-303.20157, 303.20157], 24: [-1065.9937, 1065.9937], 25: [-182.0629, 182.0629], 26: [-171.91565, 171.91565], 27: [-199.37779, 199.37779], 28: [-190.81038, 190.81038], 29: [-181.42421, 181.42421], 30: [-189.41025, 189.41025], 31: [-364.15158, 364.15158], 32: [-191.69952, 191.69952], 33: [-0.0, 0.0], 34: [-299.78357, 299.78357], 35: [-465.99106, 465.99106], 36: [-433.4436, 433.4436], 37: [-309.03775, 309.03775], 38: [-437.05536, 437.05536], 39: [-461.35114, 461.35114], 40: [-1062.6344, 1062.6344], 41: [-406.7383, 406.7383], 42: [-197.92105, 197.92105], 43: [-575.3014, 575.3014], 44: [-192.57442, 192.57442], 45: [-194.63208, 194.63208], 46: [-198.07117, 198.07117], 47: [-446.51587, 446.51587], 48: [-0.0, 0.0], 49: [-0.0, 0.0], 50: [-301.6436, 301.6436], 51: [-305.9111, 305.9111], 52: [-320.81067, 320.81067], 53: [-457.8309, 457.8309], 54: [-305.64447, 305.64447], 55: [-440.85556, 440.85556], 56: [-997.7101, 997.7101], 57: [-186.0006, 186.0006], 58: [-186.29123, 186.29123], 59: [-187.34105, 187.34105], 60: [-187.99289, 187.99289], 61: [-202.7102, 202.7102], 62: [-549.07916, 549.07916], 63: [-371.51907, 371.51907]}
                  
    # noise_slice: [-256, null] # last 256 samples
    pps_threshold: 5000
    signal_amplitude: [5000,20000]
    gen_noise_spectrum: False
    gen_signal_spectrum: True
    gen_signal_impulse: False
    impulse_alignment_oversampling: 10
    do_filtering: False

